<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Thumbnail Generator</title>
  <!-- Link your external stylesheet -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Google Fonts (Inter + Merriweather) -->
  <!--
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Merriweather:wght@700&display=swap"
        rel="stylesheet"
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap"
    rel="stylesheet"
  >
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
</head>
<body>

<!-- TOP BAR: App Title -->
<div class="app-title-bar">
  <h1 class="app-title">DYNAMIC THUMBNAIL GENERATOR</h1>
</div>

<div class="container">
  <!-- LEFT COLUMN (Sidebar + Projects) -->
  <div class="container">
    <div class="sidebar">
      <!-- Projects Container -->
      <div class="projects-container">
        <label for="projectSelect"><strong>Projects</strong></label>

        <!-- Wrap the select in a "project-select-wrapper" so we can style the arrow -->
        <div class="project-select-wrapper">
          <select id="projectSelect"></select>
        </div>

        <div class="project-buttons">
          <!-- "New Project" with icon + text -->
          <button class="icon-button" id="newProjectBtn">
            <!-- Example inline SVG (plus icon); replace with your own -->
            <svg viewBox="0 0 24 24">
              <path fill="currentColor"
                    d="M19,11H13V5A1,1 0 0,0 12,4A1,1 0 0,0 11,5V11H5A1,1 0 0,0 4,12A1,1 0 0,0 5,13H11V19A1,1 
                    0 0,0 12,20A1,1 0 0,0 13,19V13H19A1,1 0 0,0 20,12A1,1 0 0,0 19,11Z"/>
            </svg>
            <span class="button-text">New Project</span>
          </button>

          <!-- "Delete Project" with icon + text -->
          <button class="icon-button" id="deleteProjectBtn">
            <!-- Example inline SVG (trash icon); replace with your own -->
            <svg viewBox="0 0 24 24">
              <path fill="currentColor"
                    d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 
                    19,19V6H20V4H15V3H9M7,6H17V19H7V6Z"/>
            </svg>
            <span class="button-text">Delete Project</span>
          </button>
        </div>
      </div>
      <div class="sidebar-divider"></div>

      <!-- Main Sidebar Buttons (New Thumbnail, Export) -->
      <div class="sidebar-buttons">
        <div id="newThumbnailBtn" class="lottie-button" title="Create New Thumbnail">
          <div class="lottie-animation" data-animation="new"></div>
        </div>
        <div id="exportHtmlBtn" class="lottie-button" title="Export HTML">
          <div class="lottie-animation" data-animation="export"></div>
        </div>
      </div>
      <div class="sidebar-divider"></div>

      <!-- Saved Codes List (where we show the thumbnails for the current project) -->
      <div class="saved-codes-list" id="savedThumbnailsList"></div>
    </div>

    <!-- MIDDLE COLUMN (Form + Generated Code) -->
    <div class="main-content">
      <!-- CARD: Input Form -->
      <div class="card">
        <div class="card-content">
          <!-- GIF URL Field -->
          <div class="form-group">
            <label for="gifUrl">GIF</label>
            <input type="text" id="gifUrl" placeholder="e.g. https://example.com/awesome.gif" />
          </div>

          <!-- PNG URL Field -->
          <div class="form-group">
            <label for="pngUrl">Thumbnail</label>
            <input type="text" id="pngUrl" placeholder="e.g. https://t.blings.io/XYZ/{{Param1}}" />
          </div>

          <!-- Video URL Field -->
          <div class="form-group">
            <label for="videoUrl">Video URL</label>
            <input type="text" id="videoUrl" placeholder="e.g. https://example.com/video?user={{Param1}}" />
          </div>

          <!-- Dropdown for arrangement -->
          <div class="form-group">
            <label for="arrangement">Arrangement</label>
            <select id="arrangement">
              <option value="gif_on_top">GIF on Top (PNG as Background)</option>
              <option value="png_on_top">PNG on Top (GIF as Background)</option>
            </select>
          </div>

          <!-- Buttons (Generate, Save, Send Test) -->
          <div class="generate-button-container">
            <button id="generateBtn" class="icon-button">
              <span class="button-text">Generate</span>
            </button>
            
            <button id="saveBtn" class="icon-button">
              <!-- Icon loaded dynamically via loadSvgIcon -->
            </button>
            
            <button id="sendTestBtn" class="icon-button">
              <!-- Icon loaded dynamically via loadSvgIcon -->
            </button>
          </div>
        </div>
      </div>

      <!-- CARD: Generated Code -->
      <div class="card generated-code">
        <div class="generated-code-title">Generated HTML</div>
        <div class="generated-code-content">
          <textarea
            id="outputSnippet"
            readonly
            style="width: 100%; height: 200px; background-color: transparent; border: none; color: #e1e1e1;"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN (Live Preview) -->
    <div class="live-preview">
      <div class="live-preview-title">Live Preview</div>
      <!-- Dynamic snippet gets injected here -->
      <div id="livePreview" class="live-preview-content">
        <p style="color: #999;">
          Your generated snippet will appear here automatically as you fill in the fields.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  /*
    Data Model:
    localStorage Key = "myDynamicThumbnails"

    We'll also track the currentProject in JS, so we know which array to display.
    And track currentThumbnailId for highlighting the selected thumbnail.
  */

  const STORAGE_KEY         = "myDynamicThumbnails";
  const ZAPIER_WEBHOOK_URL  = "https://hooks.zapier.com/hooks/catch/XXXXXX/XXXXXX";

  let currentProject = "";     // Keep track of which project is active
  let currentThumbnailId = null;  // If we want to highlight a selected thumbnail

  // DOM Elements
  const projectSelect       = document.getElementById('projectSelect');
  const newProjectBtn       = document.getElementById('newProjectBtn');
  const deleteProjectBtn    = document.getElementById('deleteProjectBtn');
  const newThumbnailBtn     = document.getElementById('newThumbnailBtn');
  const exportHtmlBtn       = document.getElementById('exportHtmlBtn');
  const savedList           = document.getElementById('savedThumbnailsList');

  const gifUrlInput         = document.getElementById('gifUrl');
  const pngUrlInput         = document.getElementById('pngUrl');
  const videoUrlInput       = document.getElementById('videoUrl');
  const arrangementSelect   = document.getElementById('arrangement');

  const generateBtn         = document.getElementById('generateBtn');
  const saveBtn             = document.getElementById('saveBtn');
  const sendTestBtn         = document.getElementById('sendTestBtn');
  const outputSnippet       = document.getElementById('outputSnippet');
  const livePreview         = document.getElementById('livePreview');

  /*
    Replaces all occurrences of 'find' in 'str' with 'replace'
  */
  function replaceAll(str, find, replace) {
    return str.split(find).join(replace);
  }

  /*
    Build snippet from current form fields
  */
  function buildSnippet() {
    const gifUrl      = gifUrlInput.value.trim();
    let pngUrl        = pngUrlInput.value.trim();
    let videoUrl      = videoUrlInput.value.trim();
    const arrangement = arrangementSelect.value; // "gif_on_top" or "png_on_top"

    // Example: if you don't need {{Param1}} replacements, comment them out
    // pngUrl   = replaceAll(pngUrl, '{{Param1}}', '');
    // videoUrl = replaceAll(videoUrl, '{{Param1}}', '');

    let snippet = "";
    if (arrangement === "gif_on_top") {
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="
        padding: 0; 
        margin: 0; 
        height: 100%; 
        background-repeat: no-repeat; 
        background-position: center; 
        background-size: contain;" 
        background="${pngUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;" 
                   alt="GIF" 
                   src="${gifUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    } else {
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="
        padding: 0; 
        margin: 0; 
        height: 100%; 
        background-repeat: no-repeat; 
        background-position: center; 
        background-size: contain;" 
        background="${gifUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;" 
                   alt="PNG" 
                   src="${pngUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    }
    return snippet;
  }

  /*
    Build snippet from a localStorage item (for exporting all thumbnails)
  */
  function buildSnippetFromItem(item) {
    const gifUrl       = item.gifUrl.trim();
    const pngUrl       = item.pngUrl.trim();
    const videoUrl     = item.videoUrl.trim();
    const arrangement  = item.arrangement || "gif_on_top";

    let snippet = "";
    if (arrangement === "gif_on_top") {
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="padding: 0; margin: 0; height: 100%; background-repeat: no-repeat; background-position: center; background-size: contain;"
          background="${pngUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;"
                   alt="GIF"
                   src="${gifUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    } else {
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="padding: 0; margin: 0; height: 100%; background-repeat: no-repeat; background-position: center; background-size: contain;"
          background="${gifUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;"
                   alt="PNG"
                   src="${pngUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    }
    return snippet;
  }

  /*
    Update the live preview in real time
  */
  function updatePreview() {
    const snippet = buildSnippet();
    livePreview.innerHTML = snippet 
      || "<p style='color:#999;'>Your generated snippet will appear here automatically as you fill in the fields.</p>";
  }

  /*
    Generate Snippet: place it in the textarea
  */
  generateBtn.addEventListener('click', () => {
    outputSnippet.value = buildSnippet();
  });

  /*
    Save the current thumbnail in localStorage under the current project
  */
  saveBtn.addEventListener('click', () => {
    if (!currentProject) {
      alert("Please select or create a project first.");
      return;
    }

    const name = prompt("Name for this thumbnail?", "Untitled");
    if (!name) return;

    // Build new thumbnail item
    const newObj = {
      id: Date.now().toString(),
      name,
      gifUrl: gifUrlInput.value.trim(),
      pngUrl: pngUrlInput.value.trim(),
      videoUrl: videoUrlInput.value.trim(),
      arrangement: arrangementSelect.value
    };

    // Get all projects object
    const projects = loadAllProjects();

    // Insert into the current project's array
    if (!projects[currentProject]) {
      projects[currentProject] = [];
    }
    projects[currentProject].push(newObj);

    // Save back
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));

    loadSavedThumbnails(); // Reload the list
    alert(`"${name}" saved to project "${currentProject}"!`);
  });

  /*
    Send a Test: post snippet to Zapier or other webhook
  */
  sendTestBtn.addEventListener('click', async () => {
    const snippet = buildSnippet();
    const testEmails = prompt("Enter the test recipient email address(es):");
    if (!testEmails) {
      alert("No email address provided. Aborting test send.");
      return;
    }

    try {
      const response = await fetch('/api/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ snippet, testEmails }),
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      alert("Test request sent!");
    } catch (err) {
      console.error("Error sending test:", err);
      alert(`Failed to send test. ${err.message}`);
    }
  });

  /*
    New Thumbnail: clear the form and preview
  */
  newThumbnailBtn.addEventListener('click', () => {
    gifUrlInput.value      = "";
    pngUrlInput.value      = "";
    videoUrlInput.value    = "";
    arrangementSelect.value= "gif_on_top";
    outputSnippet.value    = "";
    livePreview.innerHTML  = "<p style='color:#999;'>Your generated snippet will appear here automatically as you fill in the fields.</p>";
  });

  /*
    Export all HTML snippets for the current project in one text file
  */
  exportHtmlBtn.addEventListener('click', () => {
    if (!currentProject) {
      alert("Please select or create a project first.");
      return;
    }

    const projects = loadAllProjects();
    const items = projects[currentProject] || [];
    if (!items.length) {
      alert("No thumbnails to export in this project.");
      return;
    }

    // Combine all snippets for the current project
    let fileContent = "";
    items.forEach(item => {
      const snippet = buildSnippetFromItem(item);
      fileContent += `\n=== Thumbnail: ${item.name} ===\n${snippet}\n`;
    });

    // Create a Blob of the combined content
    const blob = new Blob([fileContent], { type: "text/plain" });
    const downloadLink = document.createElement("a");
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = `${currentProject.replace(/\s+/g, '_')}_snippets.txt`;
    downloadLink.click();
    URL.revokeObjectURL(downloadLink.href);
  });

  /*
    New Project Button
  */
  newProjectBtn.addEventListener('click', () => {
    const projectName = prompt("Name of the new project?");
    if (!projectName) return;

    const projects = loadAllProjects();
    if (projects[projectName]) {
      alert("A project with that name already exists. Please pick a different name.");
      return;
    }

    // Create an empty array for that project
    projects[projectName] = [];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));

    // Refresh the project dropdown
    populateProjectDropdown();
    // Set currentProject to the new one
    currentProject = projectName;
    projectSelect.value = projectName;
    // Also clear the saved list
    loadSavedThumbnails();
    alert(`Project "${projectName}" created and selected.`);
  });

  /*
    Delete Project Button
  */
  deleteProjectBtn.addEventListener('click', () => {
    if (!currentProject) {
      alert("No project selected to delete.");
      return;
    }
    if (!confirm(`Are you sure you want to DELETE the entire project "${currentProject}"? This cannot be undone.`)) {
      return;
    }

    const projects = loadAllProjects();
    delete projects[currentProject];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));

    // Clear the project from memory
    currentProject = "";
    // Repopulate the dropdown
    populateProjectDropdown();
    // Clear the thumbnails list
    savedList.innerHTML = "";
    alert("Project deleted.");
  });

  /*
    Populate the Projects dropdown from localStorage
  */
  function populateProjectDropdown() {
    // Save the old selection to restore if it still exists
    const oldSelection = currentProject;

    projectSelect.innerHTML = ""; // clear out existing
    const projects = loadAllProjects();
    const keys = Object.keys(projects);

    if (!keys.length) {
      // No projects yet
      currentProject = "";
      const opt = document.createElement('option');
      opt.value = "";
      opt.textContent = "-- No Projects --";
      projectSelect.appendChild(opt);
    } else {
      keys.forEach(projectName => {
        const opt = document.createElement('option');
        opt.value = projectName;
        opt.textContent = projectName;
        projectSelect.appendChild(opt);
      });

      // If the old project still exists, select it; otherwise pick the first
      if (oldSelection && keys.includes(oldSelection)) {
        currentProject = oldSelection;
      } else {
        currentProject = keys[0];
      }
      projectSelect.value = currentProject;
    }
  }

  /*
    Load all Projects from localStorage
  */
  function loadAllProjects() {
    try {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      // Must be an object
      if (typeof data === 'object' && data !== null) {
        return data;
      }
      return {};
    } catch (err) {
      console.warn("Error parsing localStorage, resetting...");
      return {};
    }
  }

  /*
    Load saved thumbnails for the current project
  */
  function loadSavedThumbnails() {
    savedList.innerHTML = "";

    // Get the array of items for the current project
    const projects = loadAllProjects();
    const items = projects[currentProject] || [];

    items.forEach(item => {
      // Create the <div> for each item row
      const div = document.createElement('div');
      div.classList.add('saved-code-item');

      // If this item is the currently selected one, highlight it
      if (item.id === currentThumbnailId) {
        div.classList.add('selected');
      }

      // On click, set it as selected and load its data
      div.addEventListener('click', () => {
        currentThumbnailId = item.id;

        // Load fields
        gifUrlInput.value   = item.gifUrl;
        pngUrlInput.value   = item.pngUrl;
        videoUrlInput.value = item.videoUrl;
        arrangementSelect.value = item.arrangement || "gif_on_top";

        outputSnippet.value = buildSnippet();
        updatePreview();

        // Re-render to highlight the new selection
        loadSavedThumbnails();
      });

      // Title text
      const titleSpan = document.createElement('span');
      titleSpan.textContent = item.name;

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.classList.add('icon-button--small');
      deleteBtn.innerHTML = `
        <svg viewBox="0 0 24 24">
          <path fill="currentColor"
                d="M9,3V4H4V6H5V19A2,2 0 0,0 
                 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,
                 6H17V19H7V6Z" />
        </svg>
      `;
      // Stop row click event when deleting
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm(`Delete thumbnail "${item.name}"?`)) {
          removeThumbnailFromProject(item.id);
        }
      });

      // Build the row
      div.appendChild(titleSpan);
      div.appendChild(deleteBtn);
      savedList.appendChild(div);
    });
  }

  /*
    Remove a specific thumbnail from the current project (by item.id)
  */
  function removeThumbnailFromProject(itemId) {
    const projects = loadAllProjects();
    let items = projects[currentProject];
    if (!items) return;

    // Filter out the item
    items = items.filter(x => x.id !== itemId);
    projects[currentProject] = items; // Save back

    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
    loadSavedThumbnails();
  }

  // Event: Switch Projects in the dropdown
  projectSelect.addEventListener('change', () => {
    currentProject = projectSelect.value;
    loadSavedThumbnails();
  });

  // On page load, init
  function init() {
    populateProjectDropdown();
    loadSavedThumbnails();

    [gifUrlInput, pngUrlInput, videoUrlInput, arrangementSelect]
      .forEach(field => field.addEventListener('input', updatePreview));

    updatePreview();
  }

  init();
</script>

<script>
  // Lottie Animations Data
  const LOTTIE_ANIMATIONS = {
    new: {
      path: 'iconly-icon-export-1736617280.json', // Example animation
      loop: false,
      autoplay: false
    },
    export: {
      path: 'iconly-icon-export-1736618108.json', // Example animation
      loop: false,
      autoplay: false
    }
  };
  
  // Initialize Lottie Animations
  const lottieInstances = {};
  
  document.querySelectorAll('.lottie-animation').forEach(container => {
    const animationType = container.dataset.animation;
    const config = LOTTIE_ANIMATIONS[animationType];
    
    if (config) {
      lottieInstances[animationType] = lottie.loadAnimation({
        container: container,
        renderer: 'svg',
        loop: config.loop,
        autoplay: config.autoplay,
        path: config.path
      });
    }
  });
  
  // Add hover effects
  document.querySelectorAll('.lottie-button').forEach(button => {
    const animationType = button.querySelector('.lottie-animation').dataset.animation;
    const animation = lottieInstances[animationType];

    button.addEventListener('mouseenter', () => {
      animation.setDirection(1);
      animation.play();
    });

    button.addEventListener('mouseleave', () => {
      animation.setDirection(-1);
      animation.play();
    });
  });

  // Function to load and inject SVG icons
  function loadSvgIcon(buttonId, svgPath) {
    fetch(svgPath)
      .then(response => response.text())
      .then(svgContent => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.insertAdjacentHTML('afterbegin', svgContent);
        }
      })
      .catch(err => console.error(`Error loading SVG: ${svgPath}`, err));
  }

  // Load icons for each button
  loadSvgIcon('generateBtn', 'iconly-icon-export-1736620543.svg');
  loadSvgIcon('saveBtn', './iconly-icon-export-1736620162.svg'); // Replace with correct path
  loadSvgIcon('sendTestBtn', 'iconly-icon-send-1736620564.svg'); // Replace with correct path
</script>

</body>
</html>
