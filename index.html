<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Thumbnail Generator</title>
  <!-- Link your external stylesheet -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Google Fonts (Inter + Merriweather) -->
  <!--
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link 
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Merriweather:wght@700&display=swap" 
        rel="stylesheet"
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet"
  >
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
</head>
<body>

<!-- TOP BAR: App Title -->
<div class="app-title-bar">
  <h1 class="app-title">DYNAMIC THUMBNAIL GENERATOR</h1>
</div>

<div class="container">
  <!-- LEFT COLUMN (Sidebar) -->
  <div class="container">
    <!-- LEFT COLUMN (Sidebar) -->
    <div class="sidebar">
      <!-- Wrap buttons in a container -->
      <div class="sidebar-buttons">
        <div id="newThumbnailBtn" class="lottie-button" title="Create New Thumbnail">
          <div class="lottie-animation" data-animation="new"></div>
        </div>

        <div id="exportHtmlBtn" class="lottie-button" title="Export HTML">
          <div class="lottie-animation" data-animation="export"></div>
        </div>
      </div>

      <!-- Saved Codes List -->
      <div class="saved-codes-list" id="savedThumbnailsList">
        <!-- JS will populate this -->
      </div>
    </div>

    <!-- MIDDLE COLUMN (Form + Generated Code) -->
    <div class="main-content">
      <!-- CARD: Input Form -->
      <div class="card">
        <div class="card-content">
          <!-- GIF URL Field -->
          <div class="form-group">
            <label for="gifUrl">GIF</label>
            <input type="text" id="gifUrl" placeholder="e.g. https://example.com/awesome.gif" />
          </div>

          <!-- PNG URL Field -->
          <div class="form-group">
            <label for="pngUrl">Thumbnail</label>
            <input type="text" id="pngUrl" placeholder="e.g. https://t.blings.io/XYZ/{{Param1}}" />
          </div>

          <!-- Video URL Field -->
          <div class="form-group">
            <label for="videoUrl">Video URL</label>
            <input type="text" id="videoUrl" placeholder="e.g. https://example.com/video?user={{Param1}}" />
          </div>

          <!-- Dropdown for arrangement -->
          <div class="form-group">
            <label for="arrangement">Arrangement</label>
            <select id="arrangement">
              <option value="gif_on_top">GIF on Top (PNG as Background)</option>
              <option value="png_on_top">PNG on Top (GIF as Background)</option>
            </select>
          </div>

          <!-- Buttons (Generate, Save, Send Test) -->
          <div class="generate-button-container">
            <button id="generateBtn" class="icon-button">
              <span class="button-text">Generate</span>
            </button>
            
            <button id="saveBtn" class="icon-button">
              <!-- Icon loaded dynamically via loadSvgIcon -->
            </button>
            
            <button id="sendTestBtn" class="icon-button">
              <!-- Icon loaded dynamically via loadSvgIcon -->
            </button>
          </div>
        </div>
      </div>

      <!-- CARD: Generated Code -->
      <div class="card generated-code">
        <div class="generated-code-title">Generated HTML</div>
        <div class="generated-code-content">
          <textarea
            id="outputSnippet"
            readonly
            style="width: 100%; height: 200px; background-color: transparent; border: none; color: #e1e1e1;"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN (Live Preview) -->
    <div class="live-preview">
      <div class="live-preview-title">Live Preview</div>
      <!-- Dynamic snippet gets injected here -->
      <div id="livePreview" class="live-preview-content">
        <p style="color: #999;">
          Your generated snippet will appear here automatically as you fill in the fields.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  /* 
     Constants & DOM Elements 
  */
  const STORAGE_KEY        = "myDynamicThumbnails";
  const ZAPIER_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/XXXXXX/XXXXXX";

  const newThumbnailBtn    = document.getElementById('newThumbnailBtn');
  const exportHtmlBtn      = document.getElementById('exportHtmlBtn');
  const savedList          = document.getElementById('savedThumbnailsList');

  const gifUrlInput        = document.getElementById('gifUrl');
  const pngUrlInput        = document.getElementById('pngUrl');
  const videoUrlInput      = document.getElementById('videoUrl');
  const arrangementSelect  = document.getElementById('arrangement');

  const generateBtn        = document.getElementById('generateBtn');
  const saveBtn            = document.getElementById('saveBtn');
  const sendTestBtn        = document.getElementById('sendTestBtn');
  const outputSnippet      = document.getElementById('outputSnippet');
  const livePreview        = document.getElementById('livePreview');

  /*
    Replaces all occurrences of 'find' in 'str' with 'replace'.
    If you no longer need to replace `{{Param1}}`, you can remove this function entirely.
  */
  function replaceAll(str, find, replace) {
    return str.split(find).join(replace);
  }

  /*
    Build snippet from current form fields
  */
  function buildSnippet() {
    const gifUrl      = gifUrlInput.value.trim();
    let   pngUrl      = pngUrlInput.value.trim();
    let   videoUrl    = videoUrlInput.value.trim();
    const arrangement = arrangementSelect.value; // "gif_on_top" or "png_on_top"

    // (Optional) If you truly don't need {{Param1}} logic, remove these lines:
    // pngUrl   = replaceAll(pngUrl, '{{Param1}}', '');
    // videoUrl = replaceAll(videoUrl, '{{Param1}}', '');

    let snippet = "";

    if (arrangement === "gif_on_top") {
      /* 
        SCENARIO 1: PNG is in the background; 
                    GIF is the <img> up front
      */
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="
        padding: 0; 
        margin: 0; 
        height: 100%; 
        background-repeat: no-repeat; 
        background-position: center; 
        background-size: contain;" 
        background="${pngUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;" 
                   alt="GIF" 
                   src="${gifUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    } else {
      /* 
        SCENARIO 2: GIF is in the background;
                    PNG is the <img> up front
      */
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="
        padding: 0; 
        margin: 0; 
        height: 100%; 
        background-repeat: no-repeat; 
        background-position: center; 
        background-size: contain;" 
        background="${gifUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;" 
                   alt="PNG" 
                   src="${pngUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    }

    return snippet;
  }

  /*
    Build snippet from a localStorage item
    (Re-using similar logic to buildSnippet but using the saved item properties)
  */
  function buildSnippetFromItem(item) {
    let gifUrl       = item.gifUrl.trim();
    let pngUrl       = item.pngUrl.trim();
    let videoUrl     = item.videoUrl.trim();
    const arrangement= item.arrangement || "gif_on_top";

    // (Optional) If you had placeholders, remove or replace them. 
    // pngUrl   = replaceAll(pngUrl, '{{Param1}}', '');
    // videoUrl = replaceAll(videoUrl, '{{Param1}}', '');

    let snippet = "";
    if (arrangement === "gif_on_top") {
      // PNG background, GIF on top
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="padding: 0; margin: 0; height: 100%; background-repeat: no-repeat; background-position: center; background-size: contain;"
          background="${pngUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;"
                   alt="GIF"
                   src="${gifUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    } else {
      // GIF background, PNG on top
      snippet = `
<a style="display: block; text-decoration: none; color: inherit;" href="${videoUrl}">
  <table style="width: 100%; text-align: center; border-collapse: collapse; height:100%;">
    <tbody><tr>
      <td style="padding: 0; margin: 0; height: 100%; background-repeat: no-repeat; background-position: center; background-size: contain;"
          background="${gifUrl}">
        <table style="border-collapse: collapse;" border="0" cellspacing="0" cellpadding="0" width="100%" height="100%">
          <tbody><tr>
            <td style="padding: 0; margin: 0;" valign="middle" align="center">
              <img style="max-width: 100%; height: auto; border: 0;"
                   alt="PNG"
                   src="${pngUrl}">
            </td>
          </tr></tbody>
        </table>
      </td>
    </tr></tbody>
  </table>
</a>
      `.trim();
    }

    return snippet;
  }

  /*
    Update the live preview in real time
  */
  function updatePreview() {
    const snippet = buildSnippet();
    // If snippet is empty, show placeholder text
    livePreview.innerHTML = snippet || "<p style='color:#999;'>Your generated snippet will appear here automatically as you fill in the fields.</p>";
  }

  /*
    Generate Snippet: place it in the textarea
  */
  generateBtn.addEventListener('click', () => {
    const snippet = buildSnippet();
    outputSnippet.value = snippet;
  });

  /*
    Save: store the current thumbnail in localStorage
  */
  saveBtn.addEventListener('click', () => {
    const name = prompt("Name for this thumbnail?", "Untitled");
    if (!name) return;

    const newObj = {
      id: Date.now().toString(),
      name,
      gifUrl: gifUrlInput.value.trim(),
      pngUrl: pngUrlInput.value.trim(),
      videoUrl: videoUrlInput.value.trim(),
      arrangement: arrangementSelect.value
    };

    let existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    existing.push(newObj);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));

    loadSavedThumbnails();
    alert(`"${name}" saved!`);
  });

  /*
    Send a Test: post snippet to Zapier or other webhook
  */
  sendTestBtn.addEventListener('click', async () => {
    const snippet = buildSnippet();
    const testEmails = prompt("Enter the test recipient email address(es):");
    if (!testEmails) {
      alert("No email address provided. Aborting test send.");
      return;
    }

    try {
      const response = await fetch('/api/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ snippet, testEmails }),
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      alert("Test request sent!");
    } catch (err) {
      console.error("Error sending test:", err);
      alert(`Failed to send test. ${err.message}`);
    }
  });

  /*
    New Thumbnail: clear the form and preview
  */
  newThumbnailBtn.addEventListener('click', () => {
    gifUrlInput.value      = "";
    pngUrlInput.value      = "";
    videoUrlInput.value    = "";
    arrangementSelect.value= "gif_on_top";
    outputSnippet.value    = "";
    livePreview.innerHTML  = "<p style='color:#999;'>Your generated snippet will appear here automatically as you fill in the fields.</p>";
  });

  /*
    Load saved thumbnails from localStorage and populate the sidebar
  */
  function loadSavedThumbnails() {
    const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    savedList.innerHTML = "";

    existing.forEach(item => {
      const div = document.createElement('div');
      div.classList.add('saved-code-item');
      div.innerText = item.name;
      div.addEventListener('click', () => {
        // Load item data into form
        gifUrlInput.value       = item.gifUrl;
        pngUrlInput.value       = item.pngUrl;
        videoUrlInput.value     = item.videoUrl;
        arrangementSelect.value = item.arrangement || "gif_on_top";

        // Update snippet & preview
        outputSnippet.value = buildSnippet();
        updatePreview();
      });
      savedList.appendChild(div);
    });
  }

  /*
    Export all HTML snippets in one text file
  */
  exportHtmlBtn.addEventListener('click', () => {
    const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if (!existing.length) {
      alert("No thumbnails to export.");
      return;
    }

    // Combine all snippets
    let fileContent = "";
    existing.forEach(item => {
      const snippet = buildSnippetFromItem(item);
      fileContent += `\n=== Thumbnail: ${item.name} ===\n${snippet}\n`;
    });

    // Create a Blob of the combined content
    const blob = new Blob([fileContent], { type: "text/plain" });
    const downloadLink = document.createElement("a");
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = "thumbnails_snippets.txt";
    downloadLink.click();
    URL.revokeObjectURL(downloadLink.href);
  });

  // On page load, load existing items and init watchers
  loadSavedThumbnails();
  [gifUrlInput, pngUrlInput, videoUrlInput, arrangementSelect].forEach(field => {
    field.addEventListener('input', updatePreview);
  });
  updatePreview();
</script>

<script>
  // Lottie Animations Data
  const LOTTIE_ANIMATIONS = {
    new: {
      path: 'iconly-icon-export-1736617280.json', // Example animation
      loop: false,
      autoplay: false
    },
    export: {
      path: 'iconly-icon-export-1736618108.json', // Example animation
      loop: false,
      autoplay: false
    }
  };
  
  // Initialize Lottie Animations
  const lottieInstances = {};
  
  document.querySelectorAll('.lottie-animation').forEach(container => {
    const animationType = container.dataset.animation;
    const config = LOTTIE_ANIMATIONS[animationType];
    
    if (config) {
      lottieInstances[animationType] = lottie.loadAnimation({
        container: container,
        renderer: 'svg',
        loop: config.loop,
        autoplay: config.autoplay,
        path: config.path
      });
    }
  });
  
  // Add hover effects
  document.querySelectorAll('.lottie-button').forEach(button => {
    const animationType = button.querySelector('.lottie-animation').dataset.animation;
    const animation = lottieInstances[animationType];
  
    button.addEventListener('mouseenter', () => {
      animation.setDirection(1);
      animation.play();
    });
  
    button.addEventListener('mouseleave', () => {
      animation.setDirection(-1);
      animation.play();
    });
  });

  // Function to load and inject SVG icons
  function loadSvgIcon(buttonId, svgPath) {
    fetch(svgPath)
      .then(response => response.text())
      .then(svgContent => {
        const button = document.getElementById(buttonId);
        button.insertAdjacentHTML('afterbegin', svgContent);
      })
      .catch(err => console.error(`Error loading SVG: ${svgPath}`, err));
  }

  // Load icons for each button
  loadSvgIcon('generateBtn', 'iconly-icon-export-1736620543.svg');
  loadSvgIcon('saveBtn', './iconly-icon-export-1736620162.svg'); // Replace with the correct path
  loadSvgIcon('sendTestBtn', 'iconly-icon-send-1736620564.svg'); // Replace with the correct path
  
  // Remove any duplicate click handlers from older code if necessary
</script>

</body>
</html>
